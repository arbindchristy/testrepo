CREATE OR ALTER VIEW vw_daily_0600_job_report
AS
WITH 
ReportTime AS (
    SELECT 
        DATEADD(HOUR, 6, CAST(CAST(GETDATE() AS DATE) AS DATETIME)) AS ReportRunTime,
        DATEADD(HOUR, 6, CAST(DATEADD(DAY, -1, CAST(GETDATE() AS DATE)) AS DATETIME)) AS Yesterday0600,
        DATEADD(HOUR, 6, CAST(CAST(GETDATE() AS DATE) AS DATETIME)) AS Today0600
),
AllJobNames AS (
    SELECT DISTINCT proc_def_id AS JobName 
    FROM adm_trn_jm_active_schedule
    WHERE disabled_ = 0
    UNION
    SELECT DISTINCT proc_def_ AS JobName 
    FROM adm_trn_job_instances
    WHERE start_ >= DATEADD(DAY, -30, GETDATE())
),
JobSchedules AS (
    SELECT 
        s.proc_def_id AS JobName,
        s.period_ AS ScheduleType,
        CAST(s.date_time_ AS TIME) AS ScheduledTime,
        s.disabled_,
        CASE 
            WHEN s.period_ = 'Day' 
            THEN DATEADD(SECOND, 
                         DATEDIFF(SECOND, '00:00:00', CAST(s.date_time_ AS TIME)),
                         CAST(rt.Yesterday0600 AS DATETIME))
            ELSE s.date_time_
        END AS ExpectedRunInWindow
    FROM adm_trn_jm_active_schedule s
    CROSS JOIN ReportTime rt
    WHERE s.disabled_ = 0
),
WindowExecutions AS (
    SELECT 
        j.proc_def_ AS JobName,
        j.start_,
        j.finish_,
        j.status_,
        CAST(j.start_ AS TIME) AS RunTime,
        DATEDIFF(SECOND, j.start_, j.finish_) AS DurationSeconds,
        CASE 
            WHEN CAST(j.start_ AS TIME) BETWEEN '06:00' AND '13:59' THEN 'Morning'
            WHEN CAST(j.start_ AS TIME) BETWEEN '14:00' AND '17:59' THEN 'Afternoon'
            WHEN CAST(j.start_ AS TIME) BETWEEN '18:00' AND '23:59' THEN 'Evening'
            WHEN CAST(j.start_ AS TIME) BETWEEN '00:00' AND '05:59' THEN 'Overnight'
            ELSE 'Other'
        END AS TimeCategory
    FROM adm_trn_job_instances j
    CROSS JOIN ReportTime rt
    WHERE j.start_ >= rt.Yesterday0600 
      AND j.start_ < rt.Today0600
),
JobExecutionSummary AS (
    SELECT 
        js.JobName,
        js.ScheduleType,
        js.ScheduledTime,
        js.ExpectedRunInWindow,
        MAX(we.start_) AS LastRunStart,
        MAX(we.finish_) AS LastRunEnd,
        MAX(we.status_) AS LastRunStatus,
        MAX(we.DurationSeconds) AS DurationSeconds,
        MAX(we.TimeCategory) AS RunTimeCategory,
        COUNT(we.JobName) AS TimesRanInWindow,
        CASE 
            WHEN js.ScheduleType = 'Day' 
                 AND js.ScheduledTime >= '06:00'
            THEN 1
            WHEN js.ScheduleType = 'Day' 
                 AND js.ScheduledTime BETWEEN '00:00' AND '05:59'
            THEN 1
            ELSE 0
        END AS ShouldHaveRunInWindow
    FROM JobSchedules js
    LEFT JOIN WindowExecutions we ON js.JobName = we.JobName
    GROUP BY js.JobName, js.ScheduleType, js.ScheduledTime, js.ExpectedRunInWindow
),
JobAnalysis AS (
    SELECT 
        jes.*,
        CASE 
            WHEN jes.ScheduleType = 'Once' 
                 AND jes.ExpectedRunInWindow < (SELECT Today0600 FROM ReportTime)
                 AND jes.TimesRanInWindow = 0
            THEN 'ONCE_SCHEDULE_MISSED'
            WHEN jes.ScheduleType = 'Once' 
                 AND jes.ExpectedRunInWindow < (SELECT Today0600 FROM ReportTime)
                 AND jes.TimesRanInWindow > 0
            THEN 'ONCE_SCHEDULE_COMPLETED'
            WHEN jes.ScheduleType = 'Day' 
                 AND jes.ShouldHaveRunInWindow = 1 
                 AND jes.TimesRanInWindow = 0
            THEN 'DAILY_SCHEDULE_MISSED'
            WHEN jes.ScheduleType = 'Day' 
                 AND jes.ShouldHaveRunInWindow = 1 
                 AND jes.TimesRanInWindow > 0
                 AND jes.LastRunStatus = 'COMPLETED'
            THEN 'DAILY_SCHEDULE_COMPLETED'
            WHEN jes.ScheduleType = 'Day' 
                 AND jes.ShouldHaveRunInWindow = 1 
                 AND jes.TimesRanInWindow > 0
                 AND jes.LastRunStatus = 'FAILED'
            THEN 'DAILY_SCHEDULE_FAILED'
            WHEN jes.ScheduleType = 'Day' 
                 AND jes.ShouldHaveRunInWindow = 0
            THEN 'NOT_EXPECTED_IN_WINDOW'
            ELSE 'UNKNOWN_STATUS'
        END AS AnalysisStatus,
        CASE 
            WHEN jes.ScheduleType = 'Day' 
            THEN 
                CASE 
                    WHEN jes.ScheduledTime > '06:00' 
                    THEN DATEADD(SECOND,
                                DATEDIFF(SECOND, '00:00:00', jes.ScheduledTime),
                                CAST(CAST(GETDATE() AS DATE) AS DATETIME))
                    ELSE DATEADD(SECOND,
                                DATEDIFF(SECOND, '00:00:00', jes.ScheduledTime),
                                CAST(CAST(DATEADD(DAY, 1, GETDATE()) AS DATE) AS DATETIME))
                END
            ELSE NULL
        END AS NextExpectedRun
    FROM JobExecutionSummary jes
)
SELECT 
    JobName,
    ScheduleType,
    CONVERT(VARCHAR(8), ScheduledTime, 108) AS ScheduledTime,
    CASE 
        WHEN ScheduleType = 'Day' AND ShouldHaveRunInWindow = 1 
        THEN 'Yes' 
        ELSE 'No'
    END AS ExpectedInLast24H,
    TimesRanInWindow,
    LastRunStart,
    LastRunEnd,
    LastRunStatus,
    CASE 
        WHEN DurationSeconds IS NOT NULL 
        THEN CONCAT(
            DurationSeconds/3600, 'h ', 
            (DurationSeconds%3600)/60, 'm'
        )
        ELSE NULL
    END AS LastRunDuration,
    RunTimeCategory,
    CASE AnalysisStatus
        WHEN 'ONCE_SCHEDULE_MISSED' THEN 'üî¥ ONE-TIME JOB MISSED'
        WHEN 'ONCE_SCHEDULE_COMPLETED' THEN '‚úÖ ONE-TIME JOB COMPLETED'
        WHEN 'DAILY_SCHEDULE_MISSED' THEN 'üî¥ DAILY JOB MISSED'
        WHEN 'DAILY_SCHEDULE_COMPLETED' THEN '‚úÖ DAILY JOB COMPLETED'
        WHEN 'DAILY_SCHEDULE_FAILED' THEN '‚ùå DAILY JOB FAILED'
        WHEN 'NOT_EXPECTED_IN_WINDOW' THEN '‚ÑπÔ∏è NOT EXPECTED IN REPORT WINDOW'
        ELSE '‚ö†Ô∏è ' + AnalysisStatus
    END AS Status24H,
    CASE 
        WHEN AnalysisStatus IN ('DAILY_SCHEDULE_MISSED', 'ONCE_SCHEDULE_MISSED', 'DAILY_SCHEDULE_FAILED')
        THEN 'REQUIRES ATTENTION'
        WHEN AnalysisStatus = 'DAILY_SCHEDULE_COMPLETED' 
        THEN 'COMPLETED SUCCESSFULLY'
        ELSE 'INFORMATIONAL'
    END AS Priority,
    NextExpectedRun,
    CASE 
        WHEN AnalysisStatus = 'DAILY_SCHEDULE_MISSED' 
        THEN 'Job scheduled at ' + CONVERT(VARCHAR(8), ScheduledTime, 108) + 
             ' did not run in last 24h. Investigate.'
        WHEN AnalysisStatus = 'DAILY_SCHEDULE_FAILED' 
        THEN 'Job failed at ' + CONVERT(VARCHAR(16), LastRunStart, 120) + 
             '. Review error logs.'
        WHEN AnalysisStatus = 'ONCE_SCHEDULE_MISSED' 
        THEN 'One-time job scheduled for ' + CONVERT(VARCHAR(16), ExpectedRunInWindow, 120) + 
             ' did not run. Execute manually or reschedule.'
        WHEN AnalysisStatus = 'DAILY_SCHEDULE_COMPLETED' 
        THEN 'Completed successfully in ' + 
             CONCAT(DurationSeconds/3600, 'h ', (DurationSeconds%3600)/60, 'm')
        ELSE 'No action required'
    END AS ActionItem
FROM JobAnalysis
WHERE AnalysisStatus != 'NOT_EXPECTED_IN_WINDOW'
ORDER BY 
    CASE Priority
        WHEN 'REQUIRES ATTENTION' THEN 1
        WHEN 'INFORMATIONAL' THEN 2
        ELSE 3
    END,
    ScheduledTime,
    JobName;