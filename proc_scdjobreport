CREATE OR ALTER PROCEDURE sp_GetExpertJobReport
    @IncludeAllJobs BIT = 1  -- 1 = All jobs, 0 = Only issues
AS
BEGIN
    WITH ReportData AS (
        SELECT * FROM vw_expert_job_monitoring
    )
    SELECT 
        JobName AS [Job Name],
        ScheduleType AS [Schedule Type],
        CONVERT(VARCHAR(8), ScheduledTime, 108) AS [Scheduled Time],
        CASE 
            WHEN NextExpectedRun IS NOT NULL 
            THEN CONVERT(VARCHAR(16), NextExpectedRun, 120)
            ELSE 'N/A'
        END AS [Next Expected Run],
        CASE 
            WHEN LastRunStart IS NOT NULL 
            THEN CONVERT(VARCHAR(16), LastRunStart, 120)
            ELSE 'Never'
        END AS [Last Run Start],
        CASE 
            WHEN LastRunEnd IS NOT NULL 
            THEN CONVERT(VARCHAR(16), LastRunEnd, 120)
            WHEN LastRunStatus = 'RUNNING' THEN 'Still Running'
            ELSE 'N/A'
        END AS [Last Run End],
        LastRunStatus AS [Last Status],
        LastRunDuration AS [Last Duration],
        CurrentStatus AS [Current Status],
        TimeSinceLastRun AS [Time Since Last Run],
        ActionRequired AS [Action Required]
    FROM ReportData
    WHERE @IncludeAllJobs = 1 
       OR CurrentStatus NOT IN ('✅ RAN TODAY', '✅ RAN YESTERDAY', '✅ ONE-TIME JOB COMPLETED')
    ORDER BY 
        CASE 
            WHEN CurrentStatus LIKE '%MISSED%' THEN 1
            WHEN CurrentStatus LIKE '%FAILED%' THEN 2
            WHEN CurrentStatus LIKE '%OVERDUE%' THEN 3
            ELSE 4
        END,
        [Scheduled Time];
END
GO

-- Usage:
-- For full report: EXEC sp_GetExpertJobReport @IncludeAllJobs = 1;
-- For issues only: EXEC sp_GetExpertJobReport @IncludeAllJobs = 0;
